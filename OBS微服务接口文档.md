# OBS微服务接口文档

## 说明

- 排版规定

  | 排版格式 | 含义     |
  | -------- | -------- |
  | <>       | 变量     |
  | []       | 可选项   |
  | {}       | 必选项   |
  | \|       | 互斥关系 |

- 编码
  默认为UTF-8编码

- 请求发送

  目前,不对请求方式做限定
  
- 业务系统注册
  业务系统需先在OBS微服务中完成注册([详见 接口说明-业务系统注册接口](###1.业务系统注册接口)),获取到**系统编码、系统秘钥**
  
- Oauth2.0认证
  
  当前版本使用Oauth2.0的许可类型为客户端凭据许可(Client Credentials),业务系统需携带注册时颁发的系统编码、系统秘钥到认证接口([详见 接口说明-认证接口](###2.认证接口))获取token,后续访问时,需要在请求头中添加Authorization:token,若未携带或者携带token无效(非下发的token或者过期),将无法进行访问


## API规格

- 公共请求消息头

  - HTTP协议的标准请求头域均可,故不再此细致列出

- 公共响应消息头

  - HTTP协议的标准响应头域均可,故不再此细致列出

- 消息返回

  > 若不做特殊说明,OBS微服务消息返回内容将以如下格式返回

  | 返回字段 | 字段类型 | 说明       |
  | -------- | -------- | ---------- |
  | code     | String   | 消息码     |
  | msg      | String   | 消息描述   |
  | data     | Object   | 返回信息体 |

- 错误返回格式

  - 错误响应统一如下格式:

    | 参数名 | 类型   | 说明     |
    | ------ | ------ | -------- |
    | code   | String | 错误码   |
    | msg    | String | 错误描述 |
    | data   | Object | 返回信息 |
    

示例:
> {
    >
    > ​		"code" : "-100001",
    >
    > ​		"msg" : "业务系统未携带token或token无效",
    >
    > ​		"data" : ""
    >
    > }

- 系统级消息码

  | 消息码  | 描述                           |
  | ------- | ------------------------------ |
  | -100000 | 系统错误                       |
  | -100001 | 业务系统未携带token或token无效 |
  | -100002 | 参数错误                       |
  | -100003 | 凭证无效                       |
  | -100016 | 用户未授权此操作               |
  | -100021 | 远程访问失败                   |
  | -100022 | 系统编码或者token未携带        |
  | -100023 | 系统编码错误                   |
  | -100024 | 系统编码或者系统秘钥无效       |
  | -100025 | 系统编码或者token无效          |
  |         |                                |
  |         |                                |
  |         |                                |
  |         |                                |
  |         |                                |
  |         |                                |
  |         |                                |
  | -100050 | 未知的存储类型                 |
  | 000000  | 成功                           |

- 业务级错误码
  参见各接口错误码
  

## 接口说明

### 1.业务系统注册接口

- 接口功能

  > 业务系统在OBS微服务中进行注册,若注册成功,OBS返回给调用方**系统编码、系统秘钥**

- URI

  ```text
  /obs/sys/register
  ```

- 请求方式

  ```text
  POST;请求体使用JSON
  ```

- path参数
  无

- query参数
  无

- 请求消息头
  **暂无**

- 请求参数

  | 参数     | 是否必填 | 类型   | 说明     |
  | -------- | -------- | ------ | -------- |
  | sysName  | 是       | String | 系统名称 |
  | sysAlias | 是       | String | 系统代号 |

- 返回字段

  | 返回字段 | 字段类型 | 说明     |
  | -------- | -------- | -------- |
  | code     | String   | 系统编码 |
  | secret   | String   | 系统秘钥 |

- 接口示例
  - 发送示例

    > Header->无
    >
    > Body->{
    >
    > "sysName":"XX平台-测试",
    >
    > "sysAlias":"XX-TEST"
  >
    > }

  - 返回示例
  
    > {
    >
    >   "code": "000000",
    >
    >   "msg": "成功",
    >
    >   "data": {
    >
    > ​       "code": "xxxx",
    >
    > ​        "secret": "yyyy"
    >
    >   ​	}
    >
    > }

### 2.认证接口

- 接口功能

  > 业务系统通过系统编码、系统秘钥进行认证,认证后会颁发token,后续访问需要携带token([详见 说明-Oauth2.0认证](##说明))

- URI

  ```
  /obs/sys/authorize
  ```

- 请求方式

  ```
  POST
  ```

- path参数

  无

- query参数
  无

- 请求消息头
  无

- 请求参数

  | 参数      | 是否必填 | 类型 | 说明     |
  | --------- | -------- | ---- | -------- |
  | sysCode   | 是       | 必填 | 系统编码 |
  | secretKey | 是       | 必填 | 系统秘钥 |

- 返回字段

  | 返回字段 | 字段类型 | 说明     |
  | -------- | -------- | -------- |
  | code     | String   | 消息码   |
  | msg      | String   | 消息内容 |
  | data     | String   | token    |

- 接口示例
  - 发送示例

    > Header->无
    >
    > body->sysCode: "xxxx" 
    > 		   secretKey: "yyyy" 

  - 返回示例

    > {
    >
    >   "code": "000000",
    >
    >   "msg": "成功",
    >
    >   "data": "zzzz"
    >
    > }

### 3.我的文件列表查询接口

- 接口功能

  > 通过文件的一些属性(具体见参数说明),查询**当前业务系统**中所有复合查询属性的逻辑文件列表;若属性为空,那么查询**当前业务系统**在obs中存储的所有逻辑文件
 	 一般情况下不需要使用此接口,因为每个文件返回的code应该由调用方和自己的业务关联保存!

- URI

  ```
  /obs/logicfile/list
  ```

- 请求方式

  ```
  POST
  ```

- path参数

  无

- query参数

  无

- 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |

- 请求参数

  | 参数        | 是否必填 | 类型    | 说明                                       |
  | ----------- | -------- | ------- | ------------------------------------------ |
  | id          | 否       | Long    | 逻辑文件主键id                             |
  | code        | 否       | String  | 逻辑文件的code                             |
  | createTime  | 否       | Date    | 逻辑文件创建时间                           |
  | updateTime  | 否       | Date    | 逻辑文件修改时间                           |
  | fileName    | 否       | String  | 逻辑文件名称                               |
  | mimeType    | 否       | String  | mime类型                                   |
  | length      | 否       | Long    | 文件大小                                   |
  | storageType | 否       | Integer | 存储类型                                   |
  | split       | 否       | Integer | 是否切片;0:不切片 1:切片                   |
  | total       | 否       | Integer | 分片数                                     |
  | crc32       | 否       | String  | 逻辑文件校验和                             |
  | sysCode     | 否       | String  | 系统编码                                   |
  | sysAlisa    | 否       | String  | 系统代号                                   |
  | status      | 否       | Integer | 状态;0:初始化 1:上传中 2:上传完成 3:已删除 |
  | expire      | 否       | Date    | 过期时间                                   |

- 返回字段

  | 返回字段 | 字段类型 | 说明         |
  | -------- | -------- | ------------ |
  | code     | String   | 消息码       |
  | msg      | String   | 消息内容     |
  | data     | List     | 逻辑文件列表 |

- 接口示例

  - 发送示例

    	略

  - 返回示例

    > {
    >
    >   "code": "000000",
    >
    >   "msg": "成功",
    >
    >   "data": [
    >
    > ​    {
    >
    > ​      "id": 5,
    >
    > ​      "code": "547797022192463872",
    >
    > ​      "createTime": "2022-04-19T05:22:45.000+00:00",
    >
    > ​      "updateTime": "2022-04-21T03:12:28.000+00:00",
    >
    > ​      "fileName": "5.pdf",
    >
    > ​      "mimeType": "application/pdf",
    >
    > ​      "length": 23531959,
    >
    > ​      "storageType": 0,
    >
    > ​      "split": 0,
    >
    > ​      "total": 1,
    >
    > ​      "crc32": "abc7d0a6",
    >
    > ​      "sysCode": "TEST",
    >
    > ​      "sysAlisa": "TEST",
    >
    > ​      "status": 2,
    >
    > ​      "expire": "2023-04-19T05:22:45.000+00:00"
    >
    > ​    }
    >   ]
    > }
    
### 4.快速上传(单个文件)接口

- 接口功能

  > 当文件为小文件(大小小于200MB)时,可以快速上传文件而不需要经过 预上传 -> 上传分片的步骤 来完成文件上传;
  
  	单个不需要分片的文件请使用此接口(限制单个文件大小200MB)

- URI

  ```
  POST /obs/logicfile/upload
  
  - 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |
 
- 请求方式

multipart/form-data

  | 参数        | 是否必填 | 类型    | 说明                                       |
  | ----------- | -------- | ------- | ------------------------------------------ |
  | file        | 是       | file    | 文件                                       |
  | expire      | 否       | String  | 文件的过期时间 yyyyMMdd 该字段选传,默认为1年后 |

   
  
- 请求示例

略

- 响应示例

		{
		    "code": "000000",
		    "msg": "成功",
		    "data": "733321728519835648"
		}
  
  
 ### 5.预上传接口
 - 接口功能

  > 分片上传的预上传接口
  
  	注意!!只有需要分片的文件使用预上传 方式上传,如果不分片请使用上传文件(快速)接口,分片文件的大小应该<=16MB;请合理计算分片

- URI

  ```
  POST  /obs/logicfile/preupload
  
  - 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |
  | split | 0代表不分片,1代表分片 | 是       | 0 |
  | total | 如果split=1,该值就是必填的;一共分多少片,取决于分片list的长度 | 否       | 1 |
 
- 请求方式

multipart/form-data

  | 参数        | 是否必填 | 类型    | 说明                                       |
  | ----------- | -------- | ------- | ------------------------------------------ |
  | filename        | 是       | String    | 待上传文件名称  aaa.doc                                     |
  | mimeType        | 是       | String    | 文件的mimetype ,如text/plain                                      |
  | number         | 是       | long    | 待上传文件大小                                       |
  | crc32        | 是       | String    | 待上传文件crc值                                       |
  | subCrcList        | 否       | string     | 分片文件crc的集合,如果split=1,那么subCrcList必填,且其size要和total一样,在 form-data中依次添加每个分片的crc即可              |
  | expire      | 否       | String  | 文件的过期时间 yyyyMMdd 该字段选传,默认为1年后 |

   
  
- 请求示例

略

- 响应示例

		{
		    "code": "000000",
		    "msg": "成功",
		    "data": "733321728519835648"
		}
 
 
 ### 6.上传接口
 - 接口功能

  > 使用预上传返回的文件码来上传文件;
  
  	注意!!通常只有分片上传需要使用本接口

- URI

  ```
  POST  /obs/logicfile/upload
  
  - 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |
  | code | 通过预上传接口获取的code | 是       | 693134363432759296 |
  | sequence | 该分片文件的序号,从0开始; | 是       | 0 |
  
  
- 请求查询参数(requestParams)

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | crc32 | 该分片文件的crc32  | 是       | 7851aed9 |
 
- 请求方式

multipart/form-data

  | 参数        | 是否必填 | 类型    | 说明                                       |
  | ----------- | -------- | ------- | ------------------------------------------ |
  | file        | 是       | file    | 上传文件                                     |
  

  
- 请求示例

略

- 响应示例

		{
		    "code": "000000",
		    "msg": "成功",
		}

 
### 7.删除文件接口
 - 接口功能

  > 通过文件编码删除文件接口
  

- URI

  ```
  POST  /obs/logicfile/delete
  
  - 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |
 
- 请求方式

application/json

Array[String]

  
- 请求示例

["1","2","3"]


- 响应示例

		{
		    "code": "000000",
		    "msg": "成功",
		}  
		
		
### 8.获取文件下载url

 - 接口功能

  > 通过文件码来获取文件下载链接
	注意默认文件下载链接为动态链接-下载5次就失效,生成链接后12小时,链接也会失效!!
	失效后需要重新生成链接;
	
	如果在特殊场合(比如需要将下载链接保存在数据库,项目方案采用后端下载后传递BLOB给用户等不会把静态链接暴露给用户的场合)需要静态链接可以在请求头添加 forceStaticLink 来生成静态链接;
	注意!!!!!!切勿将静态链接暴露给用户
  

- URI

  ```
  GET  /opto/logicfile/queryDownloadInfo/{filecode}
  
  - 请求消息头

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | Authorization | 认证接口颁发的token | 是       | Authorization:"zzzz" |
  | forceStaticLink | 该字段选传; 是否强行生成合并文件静态链接,除非有特殊业务,否则不要传此此段;传此字段将导致查询的下载链接永久生效!! | 否       | false  |
 
- Path参数

  | 参数          | 说明                | 是否必须 | 示例                 |
  | ------------- | ------------------- | -------- | -------------------- |
  | filecode | 文件编码 | 是       | 733321728519835648 |

  
- 请求示例

略


- 响应示例

		{
		  "code": "000000",
		  "msg": "成功",
		  "data": {
		    "id": 0,
		    "code": "594138173278605312",
		    "fileName": "test.txt",
		    "mimeType": "text/plain",
		    "length": 123,
		    "split": 0,
		    "total": 1,
		    "crc32": "aeae1470",
		    "url": "string",
		    "files": [
		      {
		        "length": 0,
		        "batchCode": "string",
		        "crc32": "string",
		        "sequence": 0,
		        "url": "string"
		      }
		    ]
		  }
		}  